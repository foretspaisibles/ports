name: Test
on: push
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
jobs:
  test:
    runs-on: macOS-12
    defaults:
      run:
        shell: bash
    env:
      MACPORTS_PKG_URL: https://github.com/macports/macports-base/releases/download/v2.8.1/MacPorts-2.8.1-12-Monterey.pkg
    steps:
    - uses: actions/checkout@v3
    - uses: actions/cache@v3
      id: cache-macports-pkg
      with:
        path: MacPorts.pkg
        key: ${{ env.MACPORTS_PKG_URL }}-macports
    - name: Install MacPorts package
      if: steps.cache-macports-pkg.outputs.cache-hit != 'true'
      run: |
        curl -Lo MacPorts.pkg ${{ env.MACPORTS_PKG_URL }}
        sudo installer -pkg MacPorts.pkg -target /
    - name: Add MacPorts path
      run: echo '/opt/local/bin' >> "$GITHUB_PATH"
    - name: Update MacPorts
      run: sudo port -v selfupdate
    - name: Add local ports to sources
      run: sudo echo 'file://${{ github.workspace }}' >> /opt/local/etc/macports/sources.conf
    - name: Check PortIndex
      run: |
        portindex
        git diff --exit-code HEAD -- PortIndex PortIndex.quick
    - name: Lint
      run: cut -d ' ' -f 1 PortIndex.quick | xargs port lint --nitpick
    - name: Install
      id: install
      run: cut -d ' ' -f 1 PortIndex.quick | sudo xargs port install 2>&1 | tee "$TMPDIR/install.log"
    - name: Show failure log
      if: failure() && steps.install.outcome == 'failure'
      run: grep 'Error:' "$TMPDIR/install.log" | grep -o ' /[^ ]*[.]log ' | xargs cat
